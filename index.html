 <!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR WebOS v2.0 - Enhanced Virtual Reality Operating System</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }
        #canvas3d {
            width: 100%;
            height: 100%;
            display: block;
            cursor: none;
        }
        
        /* Enhanced UI Design */
        #ui {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px);
            color: white;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        input::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .app-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }
        
        .app-btn {
            background: rgba(255,255,255,0.08);
            color: white;
            border: none;
            padding: 20px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .app-btn:hover {
            background: rgba(255,255,255,0.15);
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        h3 {
            margin: 0 0 20px 0;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 24px;
            font-weight: 600;
        }
        
        /* System Windows */
        .window {
            position: fixed;
            background: rgba(0,0,10,0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(102, 126, 234, 0.6);
            border-radius: 15px;
            color: white;
            display: none;
            z-index: 2000;
            min-width: 500px;
            min-height: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            animation: windowOpen 0.3s ease-out;
        }
        
        @keyframes windowOpen {
            from { transform: scale(0.8) translateY(50px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .window-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            border-radius: 13px 13px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            font-weight: 500;
        }
        
        .window-content {
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: rgba(255,0,0,0.6);
            transform: scale(1.1);
        }
        
        /* Status Bar */
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* File Items */
        .file-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin: 4px 0;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .file-item:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.4);
            transform: translateX(5px);
        }
        
        /* Terminal Styling */
        .terminal-content {
            background: #0a0a0a;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            border-radius: 0 0 13px 13px;
        }
        
        .terminal-line {
            color: #00ff00;
            margin: 2px 0;
        }
        
        .terminal-input-line {
            display: flex;
            align-items: center;
            color: #00ff00;
            margin-top: 10px;
        }
        
        .terminal-prompt {
            margin-right: 8px;
            font-weight: bold;
        }
        
        #terminal-input {
            background: none;
            border: none;
            color: #00ff00;
            flex: 1;
            font-family: inherit;
            font-size: inherit;
        }
        
        /* Version Badge */
        .version-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
        }
        
        /* Performance Monitor */
        .perf-monitor {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 11px;
            z-index: 1000;
            font-family: monospace;
        }
        
        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            font-size: 18px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            #ui {
                max-width: 280px;
                padding: 15px;
            }
            
            .app-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .window {
                min-width: 90%;
                min-height: 60%;
                top: 5%;
                left: 5%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div>VR WebOS v2.0</div>
        <div style="font-size: 14px; margin-top: 10px;">Initializing Virtual Environment...</div>
    </div>
    
    <!-- Version Badge -->
    <div class="version-badge">v2.0</div>
    
    <!-- Performance Monitor -->
    <div class="perf-monitor" id="perf-monitor">
        <div>FPS: <span id="fps">60</span></div>
        <div>Objects: <span id="object-count">0</span></div>
        <div>Memory: <span id="memory-usage">0</span>MB</div>
    </div>
    
    <!-- Main Canvas -->
    <canvas id="canvas3d"></canvas>
    
    <!-- Control Panel -->
    <div id="ui">
        <h3>🖥️ VR WebOS v2.0</h3>
        
        <div class="app-grid">
            <button class="app-btn" onclick="VRWebOS.openApp('files')">📁<br>Files</button>
            <button class="app-btn" onclick="VRWebOS.openApp('terminal')">⚡<br>Terminal</button>
            <button class="app-btn" onclick="VRWebOS.openApp('browser')">🌐<br>Browser</button>
            <button class="app-btn" onclick="VRWebOS.openApp('games')">🎮<br>Games</button>
            <button class="app-btn" onclick="VRWebOS.openApp('media')">🎵<br>Media</button>
            <button class="app-btn" onclick="VRWebOS.openApp('code')">💻<br>Code</button>
            <button class="app-btn" onclick="VRWebOS.openApp('chat')">💬<br>Chat</button>
            <button class="app-btn" onclick="VRWebOS.openApp('tools')">🔧<br>Tools</button>
            <button class="app-btn" onclick="VRWebOS.openApp('settings')">⚙️<br>Settings</button>
        </div>
        
        <input type="text" id="url-input" placeholder="🌐 Enter URL or search term...">
        <button class="btn" onclick="VRWebOS.createWebDesktop()">🚀 Create Web Desktop</button>
        
        <input type="file" id="file-input" multiple onchange="VRWebOS.uploadFiles(event)" style="font-size: 12px; padding: 8px;">
        
        <button class="btn" onclick="VRWebOS.enterVR()">🥽 Enter VR Mode</button>
        <button class="btn" onclick="VRWebOS.arrangeDesktops()">📐 Auto Arrange</button>
        <button class="btn" onclick="VRWebOS.resetEnvironment()">🔄 Reset Environment</button>
        
        <div style="font-size: 12px; margin-top: 15px; text-align: center; opacity: 0.7;">
            Desktops: <span id="desktop-count">0</span> •
            Files: <span id="file-count">0</span> •
            Uptime: <span id="uptime">00:00</span>
        </div>
    </div>

    <!-- Enhanced File Manager -->
    <div id="file-window" class="window" style="top: 8%; left: 25%;">
        <div class="window-header">
            <span>📁 Advanced File Manager</span>
            <button class="close-btn" onclick="VRWebOS.closeWindow('file-window')">✕</button>
        </div>
        <div class="window-content">
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="VRWebOS.createFile()" style="width: auto; margin: 0 5px 0 0;">➕ New File</button>
                <button class="btn" onclick="VRWebOS.createFolder()" style="width: auto; margin: 0 5px 0 0;">📁 New Folder</button>
                <button class="btn" onclick="VRWebOS.importFile()" style="width: auto; margin: 0;">📥 Import</button>
            </div>
            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <div id="file-breadcrumb" style="margin-bottom: 10px; font-size: 12px; opacity: 0.7;"></div>
                <div id="file-list"></div>
            </div>
        </div>
    </div>

    <!-- Enhanced Terminal -->
    <div id="terminal-window" class="window" style="top: 10%; left: 30%;">
        <div class="window-header">
            <span>⚡ VR WebOS Terminal v2.0</span>
            <button class="close-btn" onclick="VRWebOS.closeWindow('terminal-window')">✕</button>
        </div>
        <div class="window-content terminal-content">
            <div class="terminal-line">VR WebOS Terminal v2.0 - Enhanced Command Interface</div>
            <div class="terminal-line">Type 'help' for available commands, 'about' for system info</div>
            <div class="terminal-line">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>
            <div id="terminal-output"></div>
            <div class="terminal-input-line">
                <span class="terminal-prompt">vrwebos@system:~$</span>
                <input type="text" id="terminal-input" onkeypress="VRWebOS.handleCommand(event)" autocomplete="off">
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
        <div>
            🖱️ WASD + Mouse: Navigate • Click: Focus Desktop • 
            <span id="active-desktop">Active: None</span>
        </div>
        <div>
            <span id="system-time">--:--:--</span> • 
            Storage: <span id="storage-info">0 KB</span> • 
            Network: <span id="network-status">Online</span>
        </div>
    </div>

    <script>
        // VR WebOS v2.0 - Enhanced Virtual Reality Operating System
        window.VRWebOS = {
            // Version Info
            version: '2.0.0',
            buildDate: new Date().toISOString().split('T')[0],
            
            // Core 3D System
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,
            
            // Enhanced 3D Environment
            camera: { 
                x: 0, y: 1.6, z: -6, 
                rotX: 0, rotY: 0,
                fov: 70,
                speed: 0.12
            },
            
            // System Components
            desktops: [],
            files: {},
            processes: [],
            particles: [],
            lights: [],
            
            // Enhanced Controls
            keys: {},
            mouseDown: false,
            touchSupport: false,
            
            // Performance Monitoring
            performance: {
                fps: 0,
                frameCount: 0,
                lastTime: 0,
                memory: 0
            },
            
            // System State
            startTime: Date.now(),
            currentPath: '/',
            
            // Initialize Enhanced VR WebOS
            async init() {
                console.log("🚀 Booting VR WebOS v2.0...");
                
                // Show loading screen
                this.showBootSequence();
                
                // Initialize core systems
                await this.initializeCore();
                await this.loadSystemData();
                await this.setupEnhancedEnvironment();
                await this.startSystemServices();
                
                // Hide loading and show interface
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    this.animate();
                    console.log("✅ VR WebOS v2.0 Ready!");
                }, 2000);
            },
            
            showBootSequence() {
                const messages = [
                    "Loading 3D Engine...",
                    "Initializing File System...",
                    "Starting Network Services...",
                    "Loading Virtual Environment...",
                    "Preparing VR Interface..."
                ];
                
                let i = 0;
                const loadingText = document.querySelector('#loading-screen div:last-child');
                
                const interval = setInterval(() => {
                    if (i < messages.length) {
                        loadingText.textContent = messages[i];
                        i++;
                    } else {
                        clearInterval(interval);
                    }
                }, 400);
            },
            
            async initializeCore() {
                this.canvas = document.getElementById('canvas3d');
                this.ctx = this.canvas.getContext('2d');
                
                // Check for touch support
                this.touchSupport = 'ontouchstart' in window;
                
                this.resize();
                this.setupEnhancedControls();
                
                // Initialize 3D environment
                this.createEnhancedParticles();
                this.createDynamicLighting();
            },
            
            async loadSystemData() {
                const saved = localStorage.getItem('vrwebos-v2-data');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.files = data.files || {};
                        this.desktops = data.desktops || [];
                        this.camera = {...this.camera, ...data.camera};
                    } catch (e) {
                        console.warn("Failed to load saved data, using defaults");
                        this.createDefaultFiles();
                    }
                } else {
                    this.createDefaultFiles();
                }
                
                if (this.desktops.length === 0) {
                    this.createWelcomeDesktop();
                }
                
                this.updateAllCounters();
            },
            
            createDefaultFiles() {
                this.files = {
                    'Documents': {
                        'welcome-v2.txt': 'Welcome to VR WebOS v2.0!\n\nNew Features:\n- Enhanced 3D graphics\n- Better performance\n- More applications\n- Improved file system\n- Advanced terminal\n\nEnjoy exploring your virtual workspace!',
                        'changelog.md': '# VR WebOS v2.0 Changelog\n\n## New Features\n- Enhanced UI design\n- Performance monitoring\n- Better 3D rendering\n- Mobile support\n- Advanced terminal commands\n\n## Bug Fixes\n- Improved stability\n- Better error handling\n- Memory optimizations'
                    },
                    'Downloads': {},
                    'Programs': {
                        'calculator.exe': 'Advanced Calculator v2.0',
                        'notepad.exe': 'Enhanced Text Editor v2.0',
                        'browser.exe': 'VR Web Browser v2.0',
                        'mediaplayer.exe': 'VR Media Player v2.0'
                    },
                    'Games': {
                        'tetris.rom': 'Classic Tetris ROM',
                        'snake.rom': 'Snake Game ROM',
                        'pong.rom': 'Pong Game ROM'
                    },
                    'System': {
                        'config.json': '{"theme":"dark","performance":"high","vr":"enabled","version":"2.0.0"}',
                        'logs.txt': 'System startup log...'
                    }
                };
            },
            
            setupEnhancedControls() {
                // Resize handler
                window.addEventListener('resize', () => this.resize());
                
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    
                    // System shortcuts
                    if (e.ctrlKey) {
                        switch(e.key) {
                            case 's':
                                e.preventDefault();
                                this.saveSystemData();
                                break;
                            case 'o':
                                e.preventDefault();
                                this.openApp('files');
                                break;
                            case '`':
                                e.preventDefault();
                                this.openApp('terminal');
                                break;
                        }
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
                
                // Enhanced mouse controls
                this.canvas.addEventListener('mousedown', (e) => {
                    this.mouseDown = true;
                    this.clickDesktop(e);
                });
                
                document.addEventListener('mouseup', () => {
                    this.mouseDown = false;
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (this.mouseDown && document.pointerLockElement === this.canvas) {
                        this.camera.rotY += e.movementX * 0.003;
                        this.camera.rotX += e.movementY * 0.003;
                        this.camera.rotX = Math.max(-1.5, Math.min(1.5, this.camera.rotX));
                    }
                });
                
                // Touch controls for mobile
                if (this.touchSupport) {
                    this.setupTouchControls();
                }
                
                // Pointer lock
                this.canvas.addEventListener('click', () => {
                    this.canvas.requestPointerLock();
                });
            },
            
            setupTouchControls() {
                let touchStartX, touchStartY;
                
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        const deltaX = touch.clientX - touchStartX;
                        const deltaY = touch.clientY - touchStartY;
                        
                        this.camera.rotY += deltaX * 0.01;
                        this.camera.rotX += deltaY * 0.01;
                        this.camera.rotX = Math.max(-1.5, Math.min(1.5, this.camera.rotX));
                        
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;
                    }
                });
                
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (e.changedTouches.length === 1) {
                        this.clickDesktop(e.changedTouches[0]);
                    }
                });
            },
            
            createEnhancedParticles() {
                this.particles = [];
                for (let i = 0; i < 40; i++) {
                    this.particles.push({
                        x: (Math.random() - 0.5) * 50,
                        y: Math.random() * 15 + 2,
                        z: (Math.random() - 0.5) * 50,
                        vx: (Math.random() - 0.5) * 0.02,
                        vy: (Math.random() - 0.5) * 0.01,
                        vz: (Math.random() - 0.5) * 0.02,
                        color: ['#667eea', '#764ba2', '#f093fb', '#f5576c'][Math.floor(Math.random() * 4)],
                        size: Math.random() * 0.1 + 0.05,
                        life: 1.0
                    });
                }
            },
            
            createDynamicLighting() {
                this.lights = [
                    { x: 10, y: 5, z: 10, color: '#667eea', intensity: 0.8 },
                    { x: -10, y: 5, z: 10, color: '#764ba2', intensity: 0.6 },
                    { x: 0, y: 8, z: -10, color: '#f093fb', intensity: 0.7 }
                ];
            },
            
            async setupEnhancedEnvironment() {
                // Create welcome desktop if none exist
                if (this.desktops.length === 0) {
                    this.createWelcomeDesktop();
                }
            },
            
            async startSystemServices() {
                // System time updater
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('system-time').textContent = 
                        now.toLocaleTimeString();
                    
                    // Update uptime
                    const uptime = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(uptime / 60);
                    const seconds = uptime % 60;
                    document.getElementById('uptime').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
                
                // Performance monitor
                setInterval(() => {
                    this.updatePerformanceMonitor();
                }, 2000);
                
                // Auto-save system data
                setInterval(() => {
                    this.saveSystemData();
                }, 30000);
                
                // Network status simulation
                setInterval(() => {
                    document.getElementById('network-status').textContent = 
                        navigator.onLine ? 'Online' : 'Offline';
                }, 5000);
            },
            
            updatePerformanceMonitor() {
                // Calculate FPS
                const now = performance.now();
                this.performance.fps = Math.round(1000 / (now - this.performance.lastTime));
                this.performance.lastTime = now;
                
                // Update memory usage (approximation)
                this.performance.memory = Math.round(
                    (JSON.stringify(this.files).length + 
                     this.desktops.length * 100 + 
                     this.particles.length * 50) / 1024
                );
                
                // Update display
                document.getElementById('fps').textContent = this.performance.fps || 60;
                document.getElementById('object-count').textContent = 
                    this.desktops.length + this.particles.length;
                document.getElementById('memory-usage').textContent = this.performance.memory;
            },
            
            resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
            },
            
            saveSystemData() {
                const data = {
                    files: this.files,
                    desktops: this.desktops,
                    camera: this.camera,
                    version: this.version,
                    lastSave: Date.now()
                };
                
                try {
                    localStorage.setItem('vrwebos-v2-data', JSON.stringify(data));
                    this.updateAllCounters();
                    console.log("💾 System data saved");
                } catch (e) {
                    console.error("Failed to save system data:", e);
                }
            },
            
            updateAllCounters() {
                // Update file count
                let fileCount = 0;
                const countFiles = (obj) => {
                    for (let key in obj) {
                        if (typeof obj[key] === 'string') fileCount++;
                        else countFiles(obj[key]);
                    }
                };
                countFiles(this.files);
                document.getElementById('file-count').textContent = fileCount;
                
                // Update desktop count
                document.getElementById('desktop-count').textContent = this.desktops.length;
                
                // Update storage info
                const size = new Blob([JSON.stringify(this.files)]).size;
                document.getElementById('storage-info').textContent = `${Math.round(size/1024)} KB`;
            },
            
            createWelcomeDesktop() {
                this.desktops.push({
                    id: 0,
                    x: 0, y: 1.6, z: 4,
                    type: 'welcome',
                    title: '🏠 Welcome to VR WebOS v2.0',
                    content: 'Enhanced Virtual Reality Operating System',
                    color: '#667eea',
                    active: true,
                    scale: 1.0,
                    rotation: 0
                });
                this.updateAllCounters();
            },
            
            // Enhanced Camera Movement
            updateCamera() {
                const speed = this.camera.speed;
                const cos = Math.cos(this.camera.rotY);
                const sin = Math.sin(this.camera.rotY);
                
                // Smooth movement with acceleration
                if (this.keys['KeyW'] || this.keys['ArrowUp']) {
                    this.camera.x += sin * speed;
                    this.camera.z += cos * speed;
                }
                if (this.keys['KeyS'] || this.keys['ArrowDown']) {
                    this.camera.x -= sin * speed;
                    this.camera.z -= cos * speed;
                }
                if (this.keys['KeyA'] || this.keys['ArrowLeft']) {
                    this.camera.x -= cos * speed;
                    this.camera.z += sin * speed;
                }
                if (this.keys['KeyD'] || this.keys['ArrowRight']) {
                    this.camera.x += cos * speed;
                    this.camera.z -= sin * speed;
                }
                if (this.keys['Space']) {
                    this.camera.y += speed;
                }
                if (this.keys['ShiftLeft'] || this.keys['ControlLeft']) {
                    this.camera.y -= speed;
                }
                
                // Speed adjustment
                if (this.keys['KeyQ']) {
                    this.camera.speed = Math.min(0.3, this.camera.speed + 0.01);
                }
                if (this.keys['KeyE']) {
                    this.camera.speed = Math.max(0.05, this.camera.speed - 0.01);
                }
            },
            
            // Enhanced 3D Projection
            project3D(x, y, z) {
                // Transform to camera space
                const dx = x - this.camera.x;
                const dy = y - this.camera.y;
                const dz = z - this.camera.z;
                
                // Apply camera rotation
                const cos = Math.cos(-this.camera.rotY);
                const sin = Math.sin(-this.camera.rotY);
                const newX = dx * cos - dz * sin;
                const newZ = dx * sin + dz * cos;
                
                const cosX = Math.cos(-this.camera.rotX);
                const sinX = Math.sin(-this.camera.rotX);
                const finalY = dy * cosX - newZ * sinX;
                const finalZ = dy * sinX + newZ * cosX;
                
                if (finalZ <= 0.1) return null;
                
                // Enhanced perspective projection
                const fovScale = Math.tan(this.camera.fov * Math.PI / 360);
                const scale = (this.height / 2) / (finalZ * fovScale);
                
                return {
                    x: this.width/2 + newX * scale,
                    y: this.height/2 + finalY * scale,
                    scale: scale,
                    depth: finalZ
                };
            },
            
            // Enhanced Rendering System
            render() {
                // Enhanced gradient background
                const gradient = this.ctx.createRadialGradient(
                    this.width/2, this.height/2, 0,
                    this.width/2, this.height/2, Math.max(this.width, this.height)
                );
                gradient.addColorStop(0, '#0a0a2e');
                gradient.addColorStop(0.5, '#16213e');
                gradient.addColorStop(1, '#0f1419');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.width, this.height);
                
                // Draw enhanced grid
                this.drawEnhancedGrid();
                
                // Update and draw particles
                this.updateParticles();
                this.drawParticles();
                
                // Draw desktops (depth sorted)
                const sortedDesktops = [...this.desktops].sort((a, b) => {
                    const depthA = Math.sqrt((a.x - this.camera.x)**2 + (a.z - this.camera.z)**2);
                    const depthB = Math.sqrt((b.x - this.camera.x)**2 + (b.z - this.camera.z)**2);
                    return depthB - depthA;
                });
                
                sortedDesktops.forEach(desktop => this.drawEnhancedDesktop(desktop));
                
                // Draw enhanced UI elements
                this.drawEnhancedCrosshair();
                this.drawCompass();
            },
            
            drawEnhancedGrid() {
                const gridSize = 100;
                const spacing = 3;
                
                this.ctx.strokeStyle = 'rgba(102, 126, 234, 0.15)';
                this.ctx.lineWidth = 1;
                
                // Main grid lines
                for (let i = -gridSize; i <= gridSize; i += spacing) {
                    const start1 = this.project3D(i, 0, -gridSize);
                    const end1 = this.project3D(i, 0, gridSize);
                    const start2 = this.project3D(-gridSize, 0, i);
                    const end2 = this.project3D(gridSize, 0, i);
                    
                    if (start1 && end1) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(start1.x, start1.y);
                        this.ctx.lineTo(end1.x, end1.y);
                        this.ctx.stroke();
                    }
                    
                    if (start2 && end2) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(start2.x, start2.y);
                        this.ctx.lineTo(end2.x, end2.y);
                        this.ctx.stroke();
                    }
                }
                
                // Center axis lines
                this.ctx.strokeStyle = 'rgba(102, 126, 234, 0.4)';
                this.ctx.lineWidth = 2;
                
                const centerX1 = this.project3D(0, 0, -gridSize);
                const centerX2 = this.project3D(0, 0, gridSize);
                const centerZ1 = this.project3D(-gridSize, 0, 0);
                const centerZ2 = this.project3D(gridSize, 0, 0);
                
                if (centerX1 && centerX2) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX1.x, centerX1.y);
                    this.ctx.lineTo(centerX2.x, centerX2.y);
                    this.ctx.stroke();
                }
                
                if (centerZ1 && centerZ2) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(centerZ1.x, centerZ1.y);
                    this.ctx.lineTo(centerZ2.x, centerZ2.y);
                    this.ctx.stroke();
                }
            },
            
            updateParticles() {
                this.particles.forEach(particle => {
                    // Update position
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.z += particle.vz;
                    
                    // Gravity and physics
                    particle.vy -= 0.001;
                    
                    // Boundary wrapping
                    if (particle.x > 25) particle.x = -25;
                    if (particle.x < -25) particle.x = 25;
                    if (particle.z > 25) particle.z = -25;
                    if (particle.z < -25) particle.z = 25;
                    if (particle.y < 0) {
                        particle.y = 0;
                        particle.vy = Math.abs(particle.vy) * 0.8;
                    }
                    if (particle.y > 15) {
                        particle.y = 15;
                        particle.vy = -Math.abs(particle.vy) * 0.8;
                    }
                    
                    // Interact with desktops (simple collision)
                    this.desktops.forEach(desktop => {
                        const dx = particle.x - desktop.x;
                        const dy = particle.y - desktop.y;
                        const dz = particle.z - desktop.z;
                        const distance = Math.sqrt(dx*dx + dy*dy + dz*dz);
                        
                        if (distance < 2) {
                            particle.vx += dx * 0.01;
                            particle.vy += dy * 0.01;
                            particle.vz += dz * 0.01;
                        }
                    });
                });
            },
            
            drawParticles() {
                this.particles.forEach(particle => {
                    const pos = this.project3D(particle.x, particle.y, particle.z);
                    if (pos && pos.depth > 0) {
                        const alpha = Math.max(0, Math.min(1, 1 - pos.depth / 30));
                        const size = Math.max(1, particle.size * pos.scale * 20);
                        
                        // Create glow effect
                        const gradient = this.ctx.createRadialGradient(
                            pos.x, pos.y, 0,
                            pos.x, pos.y, size * 2
                        );
                        gradient.addColorStop(0, particle.color + Math.floor(alpha * 255).toString(16).padStart(2, '0'));
                        gradient.addColorStop(1, particle.color + '00');
                        
                        this.ctx.fillStyle = gradient;
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, size * 2, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // Core particle
                        this.ctx.fillStyle = particle.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                });
            },
            
            drawEnhancedDesktop(desktop) {
                const size = 2.5;
                const thickness = 0.1;
                
                // Animate desktop rotation
                desktop.rotation += 0.005;
                
                // Create desktop corners with rotation
                const corners = [
                    this.project3D(
                        desktop.x + Math.cos(desktop.rotation) * size - Math.sin(desktop.rotation) * size/2,
                        desktop.y + size/2,
                        desktop.z + Math.sin(desktop.rotation) * size + Math.cos(desktop.rotation) * size/2
                    ),
                    this.project3D(
                        desktop.x + Math.cos(desktop.rotation) * size + Math.sin(desktop.rotation) * size/2,
                        desktop.y + size/2,
                        desktop.z + Math.sin(desktop.rotation) * size - Math.cos(desktop.rotation) * size/2
                    ),
                    this.project3D(
                        desktop.x - Math.cos(desktop.rotation) * size + Math.sin(desktop.rotation) * size/2,
                        desktop.y - size/2,
                        desktop.z - Math.sin(desktop.rotation) * size - Math.cos(desktop.rotation) * size/2
                    ),
                    this.project3D(
                        desktop.x - Math.cos(desktop.rotation) * size - Math.sin(desktop.rotation) * size/2,
                        desktop.y - size/2,
                        desktop.z - Math.sin(desktop.rotation) * size + Math.cos(desktop.rotation) * size/2
                    )
                ];
                
                if (corners.every(c => c)) {
                    // Draw desktop glow effect
                    if (desktop.active) {
                        this.ctx.shadowColor = desktop.color;
                        this.ctx.shadowBlur = 20;
                    }
                    
                    // Draw desktop background
                    const alpha = desktop.active ? '0.9' : '0.6';
                    this.ctx.fillStyle = desktop.color + Math.floor(parseFloat(alpha) * 255).toString(16).padStart(2, '0');
                    this.ctx.beginPath();
                    this.ctx.moveTo(corners[0].x, corners[0].y);
                    corners.forEach(corner => this.ctx.lineTo(corner.x, corner.y));
                    this.ctx.closePath();
                    this.ctx.fill();
                    
                    // Reset shadow
                    this.ctx.shadowBlur = 0;
                    
                    // Draw border with enhanced styling
                    this.ctx.strokeStyle = desktop.active ? '#ffffff' : '#cccccc';
                    this.ctx.lineWidth = desktop.active ? 3 : 2;
                    this.ctx.stroke();
                    
                    // Draw holographic scan lines
                    if (desktop.active) {
                        this.ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                        this.ctx.lineWidth = 1;
                        for (let i = 0; i < 10; i++) {
                            const y = corners[0].y + (corners[2].y - corners[0].y) * (i / 10);
                            this.ctx.beginPath();
                            this.ctx.moveTo(corners[0].x + (corners[1].x - corners[0].x) * (i / 10), y);
                            this.ctx.lineTo(corners[3].x + (corners[2].x - corners[3].x) * (i / 10), y);
                            this.ctx.stroke();
                        }
                    }
                    
                    // Draw desktop content
                    const center = this.project3D(desktop.x, desktop.y, desktop.z);
                    if (center) {
                        const fontSize = Math.max(12, Math.min(24, center.scale / 8));
                        
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = `bold ${fontSize}px Arial`;
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(desktop.title, center.x, center.y - 10);
                        
                        // Draw content
                        if (desktop.content) {
                            this.ctx.font = `${Math.max(10, fontSize - 4)}px Arial`;
                            this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
                            this.ctx.fillText(desktop.content, center.x, center.y + 15);
                        }
                        
                        // Draw URL if present
                        if (desktop.url) {
                            this.ctx.font = `${Math.max(8, fontSize - 6)}px Arial`;
                            this.ctx.fillStyle = 'rgba(255,255,255,0.6)';
                            const shortUrl = desktop.url.length > 30 ? desktop.url.substring(0, 30) + '...' : desktop.url;
                            this.ctx.fillText(shortUrl, center.x, center.y + 35);
                        }
                        
                        // Draw type indicator
                        const typeIcon = this.getDesktopIcon(desktop.type);
                        this.ctx.font = `${Math.max(16, fontSize + 4)}px Arial`;
                        this.ctx.fillText(typeIcon, center.x, center.y - 40);
                    }
                }
            },
            
            getDesktopIcon(type) {
                const icons = {
                    'welcome': '🏠',
                    'browser': '🌐',
                    'files': '📁',
                    'terminal': '⚡',
                    'games': '🎮',
                    'media': '🎵',
                    'code': '💻',
                    'chat': '💬',
                    'tools': '🔧',
                    'settings': '⚙️',
                    'web': '🔗'
                };
                return icons[type] || '🖥️';
            },
            
            drawEnhancedCrosshair() {
                const centerX = this.width / 2;
                const centerY = this.height / 2;
                const size = 15;
                
                // Animated crosshair
                const pulse = Math.sin(Date.now() * 0.005) * 0.3 + 0.7;
                this.ctx.strokeStyle = `rgba(255,255,255,${pulse})`;
                this.ctx.lineWidth = 2;
                this.ctx.setLineDash([5, 5]);
                
                this.ctx.beginPath();
                this.ctx.moveTo(centerX - size, centerY);
                this.ctx.lineTo(centerX + size, centerY);
                this.ctx.moveTo(centerX, centerY - size);
                this.ctx.lineTo(centerX, centerY + size);
                this.ctx.stroke();
                
                this.ctx.setLineDash([]);
                
                // Center dot
                this.ctx.fillStyle = `rgba(255,255,255,${pulse})`;
                this.ctx.beginPath();
                this.ctx.arc(centerX, centerY, 2, 0, Math.PI * 2);
                this.ctx.fill();
            },
            
            drawCompass() {
                const compassX = this.width - 80;
                const compassY = 80;
                const radius = 30;
                
                // Compass background
                this.ctx.fillStyle = 'rgba(0,0,0,0.7)';
                this.ctx.beginPath();
                this.ctx.arc(compassX, compassY, radius + 5, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Compass circle
                this.ctx.strokeStyle = 'rgba(255,255,255,0.8)';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.arc(compassX, compassY, radius, 0, Math.PI * 2);
                this.ctx.stroke();
                
                // North indicator
                const northX = compassX + Math.sin(-this.camera.rotY) * radius * 0.8;
                const northY = compassY + Math.cos(-this.camera.rotY) * radius * 0.8;
                
                this.ctx.fillStyle = '#ff4444';
                this.ctx.beginPath();
                this.ctx.moveTo(compassX, compassY);
                this.ctx.lineTo(northX, northY);
                this.ctx.lineWidth = 3;
                this.ctx.strokeStyle = '#ff4444';
                this.ctx.stroke();
                
                // N label
                this.ctx.fillStyle = 'white';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('N', northX, northY - 5);
            },
            
            // Enhanced Desktop Interaction
            clickDesktop(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = (e.clientX || e.pageX) - rect.left;
                const y = (e.clientY || e.pageY) - rect.top;
                
                let closest = null;
                let closestDist = Infinity;
                
                this.desktops.forEach(desktop => {
                    const center = this.project3D(desktop.x, desktop.y, desktop.z);
                    if (center) {
                        const dist = Math.sqrt((x - center.x)**2 + (y - center.y)**2);
                        if (dist < 120 && dist < closestDist) {
                            closest = desktop;
                            closestDist = dist;
                        }
                    }
                });
                
                if (closest) {
                    this.focusDesktop(closest);
                }
            },
            
            focusDesktop(desktop) {
                // Deactivate all desktops
                this.desktops.forEach(d => d.active = false);
                
                // Activate selected desktop
                desktop.active = true;
                desktop.scale = 1.2; // Slight scale animation
                
                // Update UI
                document.getElementById('active-desktop').textContent = `Active: ${desktop.title}`;
                
                console.log(`🖱️ Focused: ${desktop.title}`);
                
                // Perform desktop-specific actions
                if (desktop.url) {
                    window.open(desktop.url, '_blank');
                } else if (desktop.type === 'welcome') {
                    this.showWelcomeMessage();
                }
                
                // Smooth camera movement to desktop
                this.smoothMoveToDesktop(desktop);
            },
            
            smoothMoveToDesktop(desktop) {
                const targetX = desktop.x;
                const targetZ = desktop.z - 4;
                const targetY = 1.6;
                
                const duration = 1000; // 1 second
                const startTime = Date.now();
                const startX = this.camera.x;
                const startZ = this.camera.z;
                const startY = this.camera.y;
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function (ease-out)
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    
                    this.camera.x = startX + (targetX - startX) * easeOut;
                    this.camera.z = startZ + (targetZ - startZ) * easeOut;
                    this.camera.y = startY + (targetY - startY) * easeOut;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                animate();
            },
            
            showWelcomeMessage() {
                const message = `Welcome to VR WebOS v${this.version}!\n\nEnhancements in v2.0:\n• Improved 3D graphics\n• Better performance monitoring\n• Enhanced file system\n• Advanced terminal commands\n• Mobile touch support\n• Smooth animations\n\nUse WASD to navigate and click desktops to interact!`;
                
                alert(message);
            },
            
            // Main Animation Loop
            animate() {
                this.updateCamera();
                this.render();
                this.performance.frameCount++;
                requestAnimationFrame(() => this.animate());
            },
            
            // Application Management
            openApp(appType) {
                console.log(`🚀 Opening ${appType}...`);
                
                switch(appType) {
                    case 'files':
                        this.showEnhancedFileManager();
                        break;
                    case 'terminal':
                        this.showEnhancedTerminal();
                        break;
                    case 'browser':
                        this.createDesktop('browser', '🌐 VR Browser', null, 'https://google.com');
                        break;
                    case 'games':
                        this.createDesktop('games', '🎮 Game Center', 'Gaming Portal', 'https://poki.com');
                        break;
                    case 'media':
                        this.createDesktop('media', '🎵 Media Center', 'Music & Videos', 'https://spotify.com');
                        break;
                    case 'code':
                        this.createDesktop('code', '💻 Code Editor', 'Development Environment');
                        break;
                    case 'chat':
                        this.createDesktop('chat', '💬 VR Chat', 'Communication Hub', 'https://discord.com');
                        break;
                    case 'tools':
                        this.createDesktop('tools', '🔧 System Tools', 'Utilities & Diagnostics');
                        break;
                    case 'settings':
                        this.createDesktop('settings', '⚙️ System Settings', 'Configuration Panel');
                        break;
                }
                
                this.updateAllCounters();
            },
            
            // Enhanced File Manager
            showEnhancedFileManager() {
                const fileList = document.getElementById('file-list');
                const breadcrumb = document.getElementById('file-breadcrumb');
                
                fileList.innerHTML = '';
                breadcrumb.textContent = `📂 ${this.currentPath}`;
                
                // Navigate up button
                if (this.currentPath !== '/') {
                    const upBtn = document.createElement('div');
                    upBtn.className = 'file-item';
                    upBtn.innerHTML = '⬆️ .. (Up one level)';
                    upBtn.onclick = () => this.navigateUp();
                    fileList.appendChild(upBtn);
                }
                
                // Current directory contents
                const currentDir = this.getCurrentDirectory();
                Object.keys(currentDir).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    
                    if (typeof currentDir[item] === 'object') {
                        div.innerHTML = `📁 ${item}`;
                        div.onclick = () => this.navigateToFolder(item);
                    } else {
                        const size = new Blob([currentDir[item]]).size;
                        div.innerHTML = `📄 ${item} <span style="opacity: 0.6; font-size: 10px;">(${size} bytes)</span>`;
                        div.onclick = () => this.openFile(item);
                    }
                    
                    fileList.appendChild(div);
                });
                
                document.getElementById('file-window').style.display = 'block';
            },
            
            getCurrentDirectory() {
                if (this.currentPath === '/') {
                    return this.files;
                }
                
                const parts = this.currentPath.split('/').filter(p => p);
                let current = this.files;
                for (let part of parts) {
                    current = current[part];
                }
                return current;
            },
            
            navigateToFolder(folderName) {
                if (this.currentPath === '/') {
                    this.currentPath = `/${folderName}`;
                } else {
                    this.currentPath += `/${folderName}`;
                }
                this.showEnhancedFileManager();
            },
            
            navigateUp() {
                const parts = this.currentPath.split('/').filter(p => p);
                parts.pop();
                this.currentPath = parts.length === 0 ? '/' : '/' + parts.join('/');
                this.showEnhancedFileManager();
            },
            
            openFile(fileName) {
                const currentDir = this.getCurrentDirectory();
                const content = currentDir[fileName];
                
                if (fileName.endsWith('.exe')) {
                    this.executeProgram(fileName);
                } else {
                    // Enhanced file viewer
                    const viewer = window.open('', '_blank', 'width=800,height=600');
                    viewer.document.write(`
                        <html>
                            <head><title>${fileName} - VR WebOS File Viewer</title></head>
                            <body style="font-family: monospace; padding: 20px; background: #1a1a1a; color: white;">
                                <h2>${fileName}</h2>
                                <hr>
                                <pre style="white-space: pre-wrap;">${content}</pre>
                            </body>
                        </html>
                    `);
                    viewer.document.close();
                }
            },
            
            executeProgram(program) {
                console.log(`⚡ Executing: ${program}`);
                
                const programActions = {
                    'calculator.exe': () => this.createDesktop('tools', '🔢 Calculator', 'Advanced Calculator'),
                    'notepad.exe': () => this.createDesktop('code', '📝 Notepad', 'Text Editor'),
                    'browser.exe': () => this.createDesktop('browser', '🌐 Browser', 'Web Browser'),
                    'mediaplayer.exe': () => this.createDesktop('media', '🎵 Media Player', 'Audio/Video Player')
                };
                
                if (programActions[program]) {
                    programActions[program]();
                } else {
                    alert(`Program ${program} is not yet implemented in v2.0`);
                }
            },
            
            createFile() {
                const fileName = prompt('Enter file name (with extension):');
                if (fileName) {
                    const currentDir = this.getCurrentDirectory();
                    currentDir[fileName] = `This is a new file created on ${new Date().toLocaleString()}\n\nYou can edit this content...`;
                    this.saveSystemData();
                    this.showEnhancedFileManager();
                }
            },
            
            createFolder() {
                const folderName = prompt('Enter folder name:');
                if (folderName) {
                    const currentDir = this.getCurrentDirectory();
                    currentDir[folderName] = {};
                    this.saveSystemData();
                    this.showEnhancedFileManager();
                }
            },
            
            importFile() {
                document.getElementById('file-input').click();
            },
            
            // Enhanced Terminal
            showEnhancedTerminal() {
                document.getElementById('terminal-window').style.display = 'block';
                document.getElementById('terminal-input').focus();
            },
            
            handleCommand(event) {
                if (event.key === 'Enter') {
                    const input = event.target.value.trim();
                    const output = document.getElementById('terminal-output');
                    
                    // Add command to history
                    output.innerHTML += `<div class="terminal-line">vrwebos@system:~$ ${input}</div>`;
                    
                    // Process enhanced commands
                    this.processTerminalCommand(input, output);
                    
                    event.target.value = '';
                    output.scrollTop = output.scrollHeight;
                }
            },
            
            processTerminalCommand(cmd, output) {
                const [command, ...args] = cmd.split(' ');
                
                switch(command.toLowerCase()) {
                    case 'help':
                        output.innerHTML += `<div class="terminal-line">
VR WebOS v2.0 Terminal Commands:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
NAVIGATION:     ls, cd, pwd, tree
FILE SYSTEM:    mkdir, touch, rm, cp, mv, cat, nano
SYSTEM:         ps, kill, top, df, free, uptime, date
NETWORK:        ping, wget, curl
VR COMMANDS:    vr-mode, desktop-create, desktop-list, camera-reset
UTILITIES:      calc, weather, joke, fortune
ADVANCED:       grep, find, chmod, tar, git
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</div><br>`;
                        break;
                        
                    case 'about':
                    case 'version':
                        output.innerHTML += `<div class="terminal-line">
VR WebOS v${this.version} - Virtual Reality Operating System
Build Date: ${this.buildDate}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🖥️  Platform: Web Browser with WebXR Support
🎮  Controls: WASD + Mouse Navigation
📁  Storage: Local Browser Storage (${Math.round(JSON.stringify(this.files).length/1024)} KB)
🥽  VR Ready: ${navigator.xr ? 'Yes' : 'No'}
⚡  Performance: ${this.performance.fps} FPS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</div><br>`;
                        break;
                        
                    case 'ls':
                        const currentDir = this.getCurrentDirectory();
                        const items = Object.keys(currentDir);
                        if (items.length === 0) {
                            output.innerHTML += '<div class="terminal-line">Directory is empty</div><br>';
                        } else {
                            items.forEach(item => {
                                const isDir = typeof currentDir[item] === 'object';
                                const icon = isDir ? '📁' : '📄';
                                const size = isDir ? '<DIR>' : `${new Blob([currentDir[item]]).size}B`;
                                output.innerHTML += `<div class="terminal-line">${icon} ${item.padEnd(20)} ${size}</div>`;
                            });
                            output.innerHTML += '<br>';
                        }
                        break;
                        
                    case 'pwd':
                        output.innerHTML += `<div class="terminal-line">${this.currentPath}</div><br>`;
                        break;
                        
                    case 'cd':
                        if (args.length === 0) {
                            this.currentPath = '/';
                        } else if (args[0] === '..') {
                            this.navigateUp();
                        } else {
                            try {
                                const currentDir = this.getCurrentDirectory();
                                if (currentDir[args[0]] && typeof currentDir[args[0]] === 'object') {
                                    this.navigateToFolder(args[0]);
                                } else {
                                    output.innerHTML += `<div class="terminal-line">cd: ${args[0]}: No such directory</div><br>`;
                                }
                            } catch (e) {
                                output.innerHTML += `<div class="terminal-line">cd: ${args[0]}: No such directory</div><br>`;
                            }
                        }
                        break;
                        
                    case 'mkdir':
                        if (args.length === 0) {
                            output.innerHTML += '<div class="terminal-line">mkdir: missing operand</div><br>';
                        } else {
                            const currentDir = this.getCurrentDirectory();
                            currentDir[args[0]] = {};
                            this.saveSystemData();
                            output.innerHTML += `<div class="terminal-line">Directory '${args[0]}' created</div><br>`;
                        }
                        break;
                        
                    case 'touch':
                        if (args.length === 0) {
                            output.innerHTML += '<div class="terminal-line">touch: missing file operand</div><br>';
                        } else {
                            const currentDir = this.getCurrentDirectory();
                            currentDir[args[0]] = `File created on ${new Date().toLocaleString()}`;
                            this.saveSystemData();
                            output.innerHTML += `<div class="terminal-line">File '${args[0]}' created</div><br>`;
                        }
                        break;
                        
                    case 'cat':
                        if (args.length === 0) {
                            output.innerHTML += '<div class="terminal-line">cat: missing file operand</div><br>';
                        } else {
                            const currentDir = this.getCurrentDirectory();
                            if (currentDir[args[0]] && typeof currentDir[args[0]] === 'string') {
                                output.innerHTML += `<div class="terminal-line">${currentDir[args[0]].replace(/\n/g, '<br>')}</div><br>`;
                            } else {
                                output.innerHTML += `<div class="terminal-line">cat: ${args[0]}: No such file</div><br>`;
                            }
                        }
                        break;
                        
                    case 'rm':
                        if (args.length === 0) {
                            output.innerHTML += '<div class="terminal-line">rm: missing operand</div><br>';
                        } else {
                            const currentDir = this.getCurrentDirectory();
                            if (currentDir[args[0]]) {
                                delete currentDir[args[0]];
                                this.saveSystemData();
                                output.innerHTML += `<div class="terminal-line">Removed '${args[0]}'</div><br>`;
                            } else {
                                output.innerHTML += `<div class="terminal-line">rm: ${args[0]}: No such file or directory</div><br>`;
                            }
                        }
                        break;
                        
                    case 'ps':
                        output.innerHTML += `<div class="terminal-line">
PID  COMMAND              CPU   MEM
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
001  vrwebos-kernel       15%   ${this.performance.memory}MB
002  3d-renderer          ${this.performance.fps > 30 ? '8%' : '25%'}   32MB
003  file-manager         2%    8MB
004  terminal             1%    4MB
${this.desktops.map((d, i) => `00${5+i}  desktop-${d.id}          1%    2MB`).join('\n')}
</div><br>`;
                        break;
                        
                    case 'top':
                        output.innerHTML += `<div class="terminal-line">
VR WebOS System Monitor
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Uptime: ${Math.floor((Date.now() - this.startTime) / 1000)}s
FPS: ${this.performance.fps || 60}
Memory: ${this.performance.memory}MB
Objects: ${this.desktops.length + this.particles.length}
Storage: ${Math.round(JSON.stringify(this.files).length/1024)}KB
WebXR: ${navigator.xr ? 'Available' : 'Not Available'}
</div><br>`;
                        break;
                        
                    case 'date':
                        output.innerHTML += `<div class="terminal-line">${new Date().toString()}</div><br>`;
                        break;
                        
                    case 'uptime':
                        const uptimeSeconds = Math.floor((Date.now() - this.startTime) / 1000);
                        const hours = Math.floor(uptimeSeconds / 3600);
                        const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                        const seconds = uptimeSeconds % 60;
                        output.innerHTML += `<div class="terminal-line">System uptime: ${hours}h ${minutes}m ${seconds}s</div><br>`;
                        break;
                        
                    case 'df':
                        const storageUsed = Math.round(JSON.stringify(this.files).length/1024);
                        const storageTotal = 10240; // 10MB limit simulation
                        output.innerHTML += `<div class="terminal-line">
Filesystem     Size  Used Avail Use%
/dev/browser   ${storageTotal}K  ${storageUsed}K   ${storageTotal-storageUsed}K  ${Math.round(storageUsed/storageTotal*100)}%
</div><br>`;
                        break;
                        
                    case 'free':
                        output.innerHTML += `<div class="terminal-line">
              total        used        free      shared
Mem:           512MB       ${this.performance.memory}MB       ${512-this.performance.memory}MB       0MB
</div><br>`;
                        break;
                        
                    case 'clear':
                    case 'cls':
                        output.innerHTML = '';
                        break;
                        
                    case 'vr-mode':
                        this.enterVR();
                        output.innerHTML += '<div class="terminal-line">Attempting to enter VR mode...</div><br>';
                        break;
                        
                    case 'desktop-create':
                        const desktopType = args[0] || 'desktop';
                        const desktopTitle = args.slice(1).join(' ') || `Desktop ${this.desktops.length + 1}`;
                        this.createDesktop(desktopType, desktopTitle);
                        output.innerHTML += `<div class="terminal-line">Created desktop: ${desktopTitle}</div><br>`;
                        break;
                        
                    case 'desktop-list':
                        if (this.desktops.length === 0) {
                            output.innerHTML += '<div class="terminal-line">No desktops found</div><br>';
                        } else {
                            output.innerHTML += '<div class="terminal-line">Active Desktops:</div>';
                            this.desktops.forEach(d => {
                                const status = d.active ? '[ACTIVE]' : '[IDLE]';
                                output.innerHTML += `<div class="terminal-line">  ${d.id}: ${d.title} ${status}</div>`;
                            });
                            output.innerHTML += '<br>';
                        }
                        break;
                        
                    case 'camera-reset':
                        this.resetEnvironment();
                        output.innerHTML += '<div class="terminal-line">Camera position reset</div><br>';
                        break;
                        
                    case 'calc':
                        if (args.length === 0) {
                            output.innerHTML += '<div class="terminal-line">Usage: calc [expression]</div><br>';
                        } else {
                            try {
                                const expression = args.join(' ');
                                const result = eval(expression.replace(/[^0-9+\-*/.() ]/g, ''));
                                output.innerHTML += `<div class="terminal-line">${expression} = ${result}</div><br>`;
                            } catch (e) {
                                output.innerHTML += '<div class="terminal-line">Error: Invalid expression</div><br>';
                            }
                        }
                        break;
                        
                    case 'weather':
                        const weatherConditions = ['Sunny', 'Cloudy', 'Rainy', 'Snowy', 'Foggy'];
                        const condition = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
                        const temp = Math.floor(Math.random() * 40) - 10;
                        output.innerHTML += `<div class="terminal-line">
Virtual Weather Report:
Condition: ${condition}
Temperature: ${temp}°C
Humidity: ${Math.floor(Math.random() * 100)}%
</div><br>`;
                        break;
                        
                    case 'joke':
                        const jokes = [
                            "Why do programmers prefer dark mode? Because light attracts bugs!",
                            "How many programmers does it take to change a light bulb? None, that's a hardware problem.",
                            "Why do VR developers make good comedians? They know how to create immersive experiences!",
                            "What's a computer's favorite snack? Microchips!",
                            "Why don't robots ever panic? They have good error handling!"
                        ];
                        output.innerHTML += `<div class="terminal-line">${jokes[Math.floor(Math.random() * jokes.length)]}</div><br>`;
                        break;
                        
                    case 'fortune':
                        const fortunes = [
                            "Your VR adventures will lead to great discoveries.",
                            "A bug in your code will reveal a feature tomorrow.",
                            "Virtual reality will become your actual reality.",
                            "The best debugger is a good night's sleep.",
                            "Innovation distinguishes between a leader and a follower."
                        ];
                        output.innerHTML += `<div class="terminal-line">${fortunes[Math.floor(Math.random() * fortunes.length)]}</div><br>`;
                        break;
                        
                    case 'ping':
                        const target = args[0] || 'localhost';
                        const latency = Math.floor(Math.random() * 100) + 1;
                        output.innerHTML += `<div class="terminal-line">
PING ${target}: 64 bytes from ${target}: time=${latency}ms
PING ${target}: 64 bytes from ${target}: time=${latency+2}ms
PING ${target}: 64 bytes from ${target}: time=${latency-1}ms
</div><br>`;
                        break;
                        
                    case 'tree':
                        output.innerHTML += '<div class="terminal-line">' + this.generateFileTree() + '</div><br>';
                        break;
                        
                    case 'whoami':
                        output.innerHTML += '<div class="terminal-line">vrwebos-user</div><br>';
                        break;
                        
                    case 'history':
                        output.innerHTML += '<div class="terminal-line">Command history not implemented in v2.0</div><br>';
                        break;
                        
                    case 'exit':
                    case 'quit':
                        this.closeWindow('terminal-window');
                        break;
                        
                    default:
                        if (cmd.trim() === '') {
                            // Empty command, do nothing
                        } else {
                            output.innerHTML += `<div class="terminal-line">Command not found: ${command}</div>`;
                            output.innerHTML += '<div class="terminal-line">Type "help" for available commands</div><br>';
                        }
                        break;
                }
            },
            
            generateFileTree(obj = this.files, prefix = '', isLast = true) {
                let result = '';
                const keys = Object.keys(obj);
                
                keys.forEach((key, index) => {
                    const isLastItem = index === keys.length - 1;
                    const currentPrefix = prefix + (isLast ? '└── ' : '├── ');
                    const nextPrefix = prefix + (isLast ? '    ' : '│   ');
                    
                    result += currentPrefix + key + '\n';
                    
                    if (typeof obj[key] === 'object') {
                        result += this.generateFileTree(obj[key], nextPrefix, isLastItem);
                    }
                });
                
                return result;
            },
            
            // File Upload Handler
            uploadFiles(event) {
                const files = event.target.files;
                let uploadCount = 0;
                
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (!this.files.Downloads) this.files.Downloads = {};
                        this.files.Downloads[file.name] = e.target.result;
                        uploadCount++;
                        
                        if (uploadCount === files.length) {
                            this.saveSystemData();
                            console.log(`📥 Uploaded ${uploadCount} files to Downloads folder`);
                            
                            // Show notification
                            this.showNotification(`📥 Uploaded ${uploadCount} file(s) to Downloads`);
                        }
                    };
                    
                    if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsDataURL(file);
                    }
                }
                event.target.value = '';
            },
            
            showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(102, 126, 234, 0.9);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                    max-width: 300px;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            },
            
            // Desktop Creation
            createWebDesktop() {
                const urlInput = document.getElementById('url-input');
                let url = urlInput.value.trim();
                
                if (!url) {
                    this.showNotification('⚠️ Please enter a URL');
                    return;
                }
                
                // Enhance URL processing
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    if (url.includes('.') && !url.includes(' ')) {
                        url = 'https://' + url;
                    } else {
                        url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
                    }
                }
                
                try {
                    const hostname = new URL(url).hostname;
                    this.createDesktop('web', `🔗 ${hostname}`, 'Web Content', url);
                    urlInput.value = '';
                    this.showNotification(`🌐 Created desktop for ${hostname}`);
                } catch (e) {
                    this.showNotification('⚠️ Invalid URL format');
                }
            },
            
            createDesktop(type, title, content = '', url = null) {
                const id = this.desktops.length;
                
                // Smart positioning
                let x, z;
                if (this.desktops.length === 0) {
                    x = 0;
                    z = 4;
                } else {
                    const angle = (this.desktops.length * Math.PI * 2) / 8;
                    const radius = 8 + Math.floor(this.desktops.length / 8) * 4;
                    x = Math.sin(angle) * radius;
                    z = Math.cos(angle) * radius + 4;
                }
                
                const desktop = {
                    id: id,
                    x: x,
                    y: 1.6 + (Math.random() - 0.5) * 0.5, // Slight height variation
                    z: z,
                    type: type,
                    title: title,
                    content: content,
                    url: url,
                    color: this.getTypeColor(type),
                    active: false,
                    scale: 1.0,
                    rotation: Math.random() * 0.2 - 0.1 // Slight random rotation
                };
                
                this.desktops.push(desktop);
                this.updateAllCounters();
                
                console.log(`✅ Created ${type} desktop: ${title}`);
                return desktop;
            },
            
            getTypeColor(type) {
                const colors = {
                    'welcome': '#667eea',
                    'browser': '#3498db',
                    'files': '#f39c12',
                    'terminal': '#2ecc71',
                    'games': '#9b59b6',
                    'media': '#e91e63',
                    'code': '#ff6b35',
                    'chat': '#1abc9c',
                    'tools': '#e67e22',
                    'settings': '#e74c3c',
                    'web': '#34495e'
                };
                return colors[type] || '#95a5a6';
            },
            
            // System Controls
            arrangeDesktops() {
                this.desktops.forEach((desktop, index) => {
                    const angle = (index * Math.PI * 2) / this.desktops.length;
                    const radius = 8;
                    desktop.x = Math.sin(angle) * radius;
                    desktop.z = Math.cos(angle) * radius + 4;
                    desktop.y = 1.6;
                });
                
                this.showNotification('📐 Desktops arranged in perfect circle');
            },
            
            resetEnvironment() {
                this.camera = { x: 0, y: 1.6, z: -6, rotX: 0, rotY: 0, fov: 70, speed: 0.12 };
                this.showNotification('🔄 Environment reset to default state');
            },
            
            enterVR() {
                if (!navigator.xr) {
                    this.showNotification('❌ WebXR not supported in this browser');
                    return;
                }
                
                navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                    if (!supported) {
                        this.showNotification('❌ VR not supported on this device');
                        return;
                    }
                    
                    navigator.xr.requestSession('immersive-vr').then(session => {
                        console.log('🥽 VR mode activated');
                        document.getElementById('ui').style.display = 'none';
                        document.getElementById('status-bar').style.display = 'none';
                        this.showNotification('🥽 VR mode activated! Use hand controllers to interact');
                    }).catch(err => {
                        console.error('VR session failed:', err);
                        this.showNotification('❌ Failed to start VR session');
                    });
                }).catch(err => {
                    this.showNotification('❌ VR compatibility check failed');
                });
            },
            
            closeWindow(windowId) {
                document.getElementById(windowId).style.display = 'none';
            }
        };

        // Initialize VR WebOS v2.0 when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Add required CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // Start the system
            VRWebOS.init();
        });
        
        // Handle URL input with Enter key
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('url-input');
            if (urlInput) {
                urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        VRWebOS.createWebDesktop();
                    }
                });
            }
        });
        
        // Prevent context menu on canvas
        document.addEventListener('contextmenu', (e) => {
            if (e.target.id === 'canvas3d') {
                e.preventDefault();
            }
        });
        
        console.log("🚀 VR WebOS v2.0 loaded - Enhanced Virtual Reality Operating System ready!");
    </script>
</body>
</html>
